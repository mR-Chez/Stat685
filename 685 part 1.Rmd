---
title: "685 Part 1"
author: "Matt Chesney"
date: "6/5/2022"
output: html_document
---

```{r}
#data is built into package, this is an example for reference 
library(lme4)

# NOT RUN {
str(sleepstudy)
require(lattice)
xyplot(Reaction ~ Days | Subject, sleepstudy, type = c("g","p","r"),
       index = function(x,y) coef(lm(y ~ x))[1],
       xlab = "Days of sleep deprivation",
       ylab = "Average reaction time (ms)", aspect = "xy")
(fm1 <- lmer(Reaction ~ Days + (Days|Subject), sleepstudy,REML=F))
## independent model
(fm2 <- lmer(Reaction ~ Days + (1|Subject) + (0+Days|Subject), sleepstudy, REML=F))
# }
(fm3 <- lmer(Reaction ~ Days + (Days||Subject), sleepstudy, REML=F))
```

## Introduction 

This is a tutorial to walk through of how to complete Mixed regression in R. The tutorial is in two parts, the first is mixed regression utilizing linear methods and part 2 is generalized linear regression. 


## Mixed models 
What are mixed models? introduce fixed and random effects and how they differ.

In an experiment there is a unit that the experiment is being conducted on, this is the **Experimental Unit**. For the Experimental unit there is some measured attribute of interest, this is the **Independent variable** or our Y.  

A Fixed effect is a treatment that is applied to our experimental unit. The treatment's effect is ascertained by a shift in the average value of Y, or the independent variable being monitored.

The NULL hypothesis is that the treatment has no effect on the mean. INSERT equations for null hypothesis and test statistic here. 

Examples: 1. Comparing tensile strengths of alloy blends. 2. Comparing weight gain in pigs from several food types 3. Comparing maximum speeds of cars with different food additives 

A Random effect is also applied to the experimental unit. The treatment's effect is determined by a difference in the variation in Y due to the application of the treatment. A random effect is assigned when the population of treatments is assumed to be homogeneous. 

The NULL hypothesis is that the treatment has no effect on the variance. INSERT equations for null hypothesis and test statistic here. 

Examples: 1. A factory's various production lines effect on variation tensile strength. 2. A pig farm's pig pens' effect on variation in weight gain 3. A professional driver's effect on variation in top speeds of cars. 

The mixed model contains both fixed effects and random effects.There are several ways this relationship can manifest. The fixed effect can have a consistent effect within the random effect, intercept changes but slope remains the same. The fixed effect random effect can only vary in the presence of the fixed effect, intercept constant and slope varies. The fixed effect can vary with respect to the random effect, slope and intercept change. Each of these options will be examined in our sleep data example. 

Examples: 1. Comparing tensile strengths of alloy blends from several production lines in a factory. 2. Comparing weight gain in pigs from several food types living in one of several randomly assigned pens 3. Comparing maximum speeds of cars with different food additives driven by randomly assigned professional drivers. 


## introduction to the data
The sleepstudy dataset is available as part of the lme4 package. It is from a study conducted by Gregory Belenky, Nancy J. Wesensten, David R. Thorne, Maria L. Thomas, Helen C. Sing, Daniel P. Redmond, Michael B. Russo and Thomas J. Balkin (2003). 
The response variable is the reaction time of the subjects to stimuli as recorded by researchers [Reaction]. The Subjects are the random effect, Subject. The number of days the subject underwent sleep deprivation is the fixed effect [Days]. The interaction between Subject and Days is also random.  

```{r}
str(sleepstudy)
```


## The Model
This example will follow the convention of using Greek symbols to denote fixed effects and capital letters to denote random effects. 

The variables in out model are, $y = $Reaction, $\beta =$Days, $C = $ Subject, $\beta C = $Day*Subject interaction. Our model for this example is below. 

Model 1, Only intercept varies 

$$y_{Reaction} = \alpha_{intercept}  + C_{Subject} + \beta_{Days}*Days + e_{residual}$$

Model 2, Only slope varies

$$y_{Reaction} = \alpha_{intercept} + \beta_{Days}*Days + \beta C_{Days*Subject} + e_{residual}$$

Model 3, intercept and slope vary 

$$y_{Reaction} = \alpha_{intercept}  + C_{Subject} + \beta_{Days}*Days + \beta C_{Days*Subject}*Days + e_{residual}$$


## Introduce elements of the LME4 package
To analyze the mixed effect model we will utilize the R package LME4. 

The relevant syntax for the model is as follows: 

Random intercept effect: (1|RandomEffect)

Random Slope effect: (0+FixedEffect|RandomEffect)

Random intercept and slope with random effect correlated: 1+FixedEffect+(1+FixedEffect|RandomEffect) 
Abrreviation: FixedEffect+(FixedEffect|RandomEffect)

Random intercept and slope with random effect uncorrelated: 1+FixedEffect+(1|RandomEffect)+(0+FixedEffect|RandomEffect) 
Abrreviation: FixedEffect+(FixedEffect||RandomEffect)

We will utilize the abbreviated syntax where appropriate. 

###REML

Explain why REML is better to use than log likelihood 

## Model 1 

$$y_{Reaction} = \alpha_{intercept}  + C_{Subject} + \beta_{Days}*Days + e_{residual}$$
```{r}
#add object to hold AIC, BIC, and LOG lik for four models 
```

```{r}
model1 <- lmer(Reaction ~ Days + (1|Subject), sleepstudy,REML=T)

summary(model1)
AIC(model1)
BIC(model1)
logLik(model1)
```

##Model 2 


$$y_{Reaction} = \alpha_{intercept} + \beta_{Days}*Days + \beta C_{Days*Subject} + e_{residual}$$
```{r}
model2 <- lmer(Reaction ~ Days + (0+ Days|Subject), sleepstudy,REML=T)
summary(model2)
AIC(model2)
BIC(model2)
logLik(model2)

```

##Model 3 
$$y_{Reaction} = \alpha_{intercept}  + C_{Subject} + \beta_{Days}*Days + \beta C_{Days*Subject}*Days + e_{residual}$$
###Correlated
```{r}
model3c <- lmer(Reaction ~ Days + (Days|Subject), sleepstudy,REML=T)
summary(model3c)
AIC(model3c)
BIC(model3c)
logLik(model3c)

```

###Uncorrelated
```{r}
model3u <- lmer(Reaction ~ Days + (Days||Subject), sleepstudy,REML=T)
summary(model3c)
AIC(model3u)
BIC(model3u)
logLik(model3u)

```
```{r}
#plot AIC, BIC, log lik of 4 models, explain which one will be used, 
```


## Output 

## Explantion of output 

## bootstrap confidence intervals 

# Bayseian 

## The Bayseian model 

## Output 

## Explanation of output 

## Bayseian Bootstrap confidence intervals 

# sources 

https://cran.microsoft.com/snapshot/2021-10-10/web/packages/lme4/vignettes/lmer.pdf
https://www.lcampanelli.org/mixed-effects-modeling-lme4/
https://www.rensvandeschoot.com/tutorials/lme4/
https://vitalflux.com/fixed-vs-random-vs-mixed-effects-models-examples/
https://www.rdocumentation.org/packages/lme4/versions/1.1-29/topics/lmer

